.card#trust-asset-card
  .card-header
    .row
      .col-md-6.text-left
        %h1 Trust Asset
      .col-md-6.browse-assets-btn-container.mt-2
        %button{class: "btn btn-brown", id: "browse-assets"} Browse All Assets
  .card-body
    .form-group
      .form-label
        Public Key 
      %input.form-control{id: "source-account", value: session[:address], disabled: true, type: "text"}
    .form-group
      .form-label
        Secret Seed
      %input.form-control{id: "secret-seed", type: "password"}
    .form-group
      .form-label
        Asset Code
      %input.form-control{id: "asset-code", placeholder: "Asset Code", required: true, type: "text", value: params[:asset_code]}/
    .form-group
      .form-label
        Asset Issuer
      %input.form-control{id: "asset-issuer", placeholder: "Asset Issuer", required: true, type: "text"}/
    .form-group
      .form-label
        Limit
      %input.form-control{id: "limit", placeholder: "Amount Limit", required: true, type: "number"}/        
    %hr
    .fee-prompt.mb-2.mt-2
      Transaction fee of 0.00001 XLM will be charged for each transaction
    .container-fluid
      .row
        .col-md-12.text-center
          #progressbar
            .progress-label
              Processing. Please Wait...
        .col-md-12
          .text-right
            %button{type: "button", class: "btn btn-danger", id: "trust-btn"} Trust Asset
            = link_to "Cancel", root_path, class: "btn btn-brown", id: "cancel-btn"

%script{src: "https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/0.8.0/stellar-sdk.min.js"}
  
:javascript    
  $("#browse-assets").click(function() {
    document.location.href = '/assets'
  })
  
  function hide_form_controls(){
    $('#secret-seed').prop("disabled", true)
    $('#asset-code').prop("disabled", true)
    $('#asset-issuer').prop("disabled", true)
    $('#limit').prop("disabled", true)
    $('#trust-btn').hide()
    $('#cancel-btn').hide()
  }
  //$(document).ready(function() {
  $('#trust-btn').click(function(){
    console.log("trusting...")
    hide_form_controls()
    progressbar()
    var server = new StellarSdk.Server('https://horizon.stellar.org')

    var asset_code = document.getElementById('asset-code').value
    var asset_issuer = document.getElementById('asset-issuer').value
    var limit = document.getElementById('limit').value

    var asset = new StellarSdk.Asset(asset_code, asset_issuer)

    var sourcePublicKey = document.getElementById('source-account').value
    var sourceSecretKey = document.getElementById('secret-seed').value

    var sourceKeypair = StellarSdk.Keypair.fromSecret(sourceSecretKey)
    // var sourceKeypair = StellarSdk.Keypair.fromPublicKey(sourcePublicKey)

    console.log(asset)

    StellarSdk.Network.usePublicNetwork()

    server.loadAccount(sourcePublicKey)
    .then(function(account){
      var transaction = new StellarSdk.TransactionBuilder(account)
        .addOperation(StellarSdk.Operation.changeTrust({
          asset: asset,
          limit: limit
        }))
      .build();

      console.log("signining")
      transaction.sign(sourceKeypair)

      console.log("submitting")
      server.submitTransaction(transaction)
        .then(function(result){
          var link = result['_links']['transaction']['href']
          var message = 'Asset ' + asset_code + ' from issuer ' + asset_issuer + ', with limit ' + limit + ', trusted successfully.'
          document.location.href = '/success?transaction_url=' + link + '&message=' + message 
        })
        .catch(function(err) {
          document.location.href = '/failed?error_description=' + err
        })
    })
    .catch(function(error){
      console.log('ERROR!', error)
    })
  })

